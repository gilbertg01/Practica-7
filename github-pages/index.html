<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solicitudes en GitHub Pages - React Version</title>

  <!-- Bootstrap CSS -->
  <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          crossorigin="anonymous"
  />

  <!-- React y ReactDOM desde CDN -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- AXIOS -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>
<div class="container mt-3" id="root"></div>

<script type="text/javascript">
  const { useEffect, useState } = React;
  // Se carga la API_URL desde localStorage; si no está definida se usa el valor por defecto.
  const API_URL = localStorage.getItem("API_URL") || "/api/solicitudes/";

  function App() {
    const [requests, setRequests] = useState([]);
    const [filteredRequests, setFilteredRequests] = useState([]);
    const [showOld, setShowOld] = useState(false);

    const [formData, setFormData] = useState({
      id: "",
      nombre: "",
      matricula: "",
      correo: "",
      laboratorio: "",
      fecha: "",
      hora: ""
    });
    const [isEditing, setIsEditing] = useState(false);
    const [errorMsg, setErrorMsg] = useState("");

    useEffect(() => {
      loadRequests();
    }, []);

    useEffect(() => {
      filterRequests();
    }, [requests, showOld]);

    const loadRequests = () => {
      axios.get(API_URL)
              .then(response => {
                setRequests(response.data.solicitudes || []);
              })
              .catch(error => console.log("Error al cargar solicitudes:", error));
    };

    const filterRequests = () => {
      const hoy = new Date();
      const hoyStr = hoy.toISOString().slice(0, 10);
      const horaActual = hoy.getHours().toString().padStart(2, "0") + ":" + hoy.getMinutes().toString().padStart(2, "0");

      const filtered = requests.filter(item => {
        const pos = item.hora.indexOf(" ");
        const horaSolo = (pos > -1) ? item.hora.substring(0, pos) : item.hora;

        if (showOld) {
          return (item.fecha < hoyStr) ||
                  (item.fecha === hoyStr && horaSolo < horaActual);
        } else {
          return (item.fecha > hoyStr) ||
                  (item.fecha === hoyStr && horaSolo >= horaActual);
        }
      });
      setFilteredRequests(filtered);
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      const hoy = new Date();
      const hoyStr = hoy.toISOString().slice(0, 10);
      const horaActual = hoy.getHours().toString().padStart(2, "0") + ":" + hoy.getMinutes().toString().padStart(2, "0");
      const pos = formData.hora.indexOf(" ");
      const horaSolo = pos > -1 ? formData.hora.substring(0, pos) : formData.hora;

      if (formData.fecha < hoyStr || (formData.fecha === hoyStr && horaSolo < horaActual)) {
        setErrorMsg("No se puede registrar con fecha/hora pasadas.");
        return;
      }
      setErrorMsg("");

      if (!isEditing) {
        axios.post(API_URL, formData)
                .then(resp => {
                  if (resp.data.error) {
                    setErrorMsg(resp.data.mensajeError || "Error desconocido");
                  } else {
                    closeModal();
                    loadRequests();
                  }
                })
                .catch(err => setErrorMsg("Error al crear la solicitud: " + err.message));
      } else {
        axios.put(API_URL, formData)
                .then(resp => {
                  if (resp.data.error) {
                    setErrorMsg(resp.data.mensajeError || "Error desconocido");
                  } else {
                    closeModal();
                    loadRequests();
                  }
                })
                .catch(err => setErrorMsg("Error al actualizar la solicitud: " + err.message));
      }
    };

    const handleDelete = (solicitud) => {
      if (confirm("¿Desea eliminar la solicitud ID: " + solicitud.id + "?")) {
        axios.delete(API_URL, { data: solicitud })
                .then(() => loadRequests())
                .catch(err => console.log("Error al eliminar:", err));
      }
    };

    const openNew = () => {
      setIsEditing(false);
      setFormData({
        id: "",
        nombre: "",
        matricula: "",
        correo: "",
        laboratorio: "",
        fecha: "",
        hora: ""
      });
      setErrorMsg("");
      new bootstrap.Modal(document.getElementById("solicitudModal")).show();
    };

    const openEdit = (solicitud) => {
      setIsEditing(true);
      setFormData({ ...solicitud });
      setErrorMsg("");
      new bootstrap.Modal(document.getElementById("solicitudModal")).show();
    };

    const closeModal = () => {
      document.getElementById("closeModalButton").click();
    };

    return (
            <div>
              <h1 className="text-center">Listado de Solicitudes</h1>
              <div className="d-flex justify-content-end mb-3">
                <div className="form-check">
                  <input
                          className="form-check-input"
                          type="checkbox"
                          checked={showOld}
                          onChange={() => setShowOld(!showOld)}
                  />
                  <label className="form-check-label">
                    Registros Pasados
                  </label>
                </div>
              </div>
              <div className="mb-3">
                <button className="btn btn-primary" onClick={openNew}>Crear Solicitud</button>
              </div>
              <table className="table table-striped">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Matrícula</th>
                  <th>Correo</th>
                  <th>Laboratorio</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                {filteredRequests.map(s => (
                        <tr key={s.id}>
                          <td>{s.id}</td>
                          <td>{s.nombre}</td>
                          <td>{s.matricula}</td>
                          <td>{s.correo}</td>
                          <td>{s.laboratorio}</td>
                          <td>{s.fecha}</td>
                          <td>{s.hora}</td>
                          <td>
                            <button className="btn btn-secondary btn-sm me-2" onClick={() => openEdit(s)}>Editar</button>
                            <button className="btn btn-danger btn-sm" onClick={() => handleDelete(s)}>Eliminar</button>
                          </td>
                        </tr>
                ))}
                </tbody>
              </table>

              {/* Modal */}
              <div className="modal fade" id="solicitudModal" tabIndex="-1">
                <div className="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                  <div className="modal-content">
                    <div className="modal-header">
                      <h5>{isEditing ? "Editar Solicitud" : "Nueva Solicitud"}</h5>
                      <button
                              type="button"
                              className="btn-close"
                              id="closeModalButton"
                              data-bs-dismiss="modal"
                              aria-label="Close"
                      ></button>
                    </div>
                    <div className="modal-body">
                      {errorMsg && <div className="alert alert-danger">{errorMsg}</div>}
                      <form onSubmit={handleSubmit}>
                        <div className="mb-3">
                          <label className="form-label">Matrícula</label>
                          <input
                                  type="number"
                                  className="form-control"
                                  value={formData.matricula}
                                  onChange={(e) => setFormData({ ...formData, matricula: e.target.value })}
                                  required
                          />
                        </div>
                        <div className="mb-3">
                          <label className="form-label">Nombre</label>
                          <input
                                  type="text"
                                  className="form-control"
                                  value={formData.nombre}
                                  onChange={(e) => setFormData({ ...formData, nombre: e.target.value })}
                                  required
                          />
                        </div>
                        <div className="mb-3">
                          <label className="form-label">Correo</label>
                          <input
                                  type="email"
                                  className="form-control"
                                  value={formData.correo}
                                  onChange={(e) => setFormData({ ...formData, correo: e.target.value })}
                                  required
                          />
                        </div>
                        <div className="mb-3">
                          <label className="form-label">Laboratorio</label>
                          <select
                                  className="form-select"
                                  value={formData.laboratorio}
                                  onChange={(e) => setFormData({ ...formData, laboratorio: e.target.value })}
                                  required
                          >
                            <option value="">Seleccione</option>
                            <option value="redes">Redes</option>
                            <option value="computacion">Computación</option>
                          </select>
                        </div>
                        <div className="mb-3">
                          <label className="form-label">Fecha</label>
                          <input
                                  type="date"
                                  className="form-control"
                                  value={formData.fecha}
                                  onChange={(e) => setFormData({ ...formData, fecha: e.target.value })}
                                  required
                          />
                        </div>
                        <div className="mb-3">
                          <label className="form-label">Hora</label>
                          <select
                                  className="form-select"
                                  value={formData.hora}
                                  onChange={(e) => setFormData({...formData, hora: e.target.value})}
                                  required
                          >
                            <option value="">Seleccionar hora</option>
                            <option value="08:00 a 09:00">08:00 a 09:00</option>
                            <option value="09:00 a 10:00">09:00 a 10:00</option>
                            <option value="10:00 a 11:00">10:00 a 11:00</option>
                            <option value="11:00 a 12:00">11:00 a 12:00</option>
                            <option value="12:00 a 13:00">12:00 a 13:00</option>
                            <option value="13:00 a 14:00">13:00 a 14:00</option>
                            <option value="14:00 a 15:00">14:00 a 15:00</option>
                            <option value="15:00 a 16:00">15:00 a 16:00</option>
                            <option value="16:00 a 17:00">16:00 a 17:00</option>
                            <option value="17:00 a 18:00">17:00 a 18:00</option>
                            <option value="18:00 a 19:00">18:00 a 19:00</option>
                            <option value="19:00 a 20:00">19:00 a 20:00</option>
                            <option value="20:00 a 21:00">20:00 a 21:00</option>
                            <option value="21:00 a 22:00">21:00 a 22:00</option>
                          </select>
                        </div>
                        <button type="submit" className="btn btn-primary me-2">
                          Guardar
                        </button>
                        <button type="reset" className="btn btn-secondary" onClick={() => setErrorMsg("")}>
                          Limpiar
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
    );
  }

  ReactDOM.render(<App/>, document.getElementById("root"));
</script>

<!-- Bootstrap JS (Popper incluido)-->
<script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous">
</script>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
        crossorigin="anonymous">
</script>
</body>
</html>
