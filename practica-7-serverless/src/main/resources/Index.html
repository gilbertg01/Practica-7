<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CRUD Serverless con React</title>

    <!-- Bootstrap CSS -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
            crossorigin="anonymous"
    />

    <!-- React y ReactDOM desde CDN -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <!-- AXIOS -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>

<div class="container my-5" id="root"></div>

<script type="text/javascript">
    const { useState, useEffect } = React;
    const API_URL = localStorage.getItem("API_URL") || "/api/requests/";

    function App() {
        const [requests, setRequests] = useState([]);
        const [modalData, setModalData] = useState({
            uniqueId: "",
            studentId: "",
            fullName: "",
            emailAddress: "",
            labName: "",
            reserveDate: "",
            reserveHour: ""
        });
        const [isEditing, setIsEditing] = useState(false);
        const [errorMsg, setErrorMsg] = useState("");

        useEffect(() => {
            fetchRequests();
        }, []);

        const fetchRequests = () => {
            axios
                .get(API_URL)
                .then((response) => {
                    if (response.data.requests) {
                        setRequests(response.data.requests);
                    } else if (response.data.solicitudes) {
                        setRequests(response.data.solicitudes);
                    }
                })
                .catch((err) => {
                    console.error("Error al cargar requests", err);
                });
        };

        const handleNew = () => {
            setIsEditing(false);
            setModalData({
                uniqueId: "",
                studentId: "",
                fullName: "",
                emailAddress: "",
                labName: "",
                reserveDate: "",
                reserveHour: ""
            });
            setErrorMsg("");
            const modal = new bootstrap.Modal(document.getElementById('myModal'));
            modal.show();
        };

        const handleEdit = (item) => {
            setIsEditing(true);
            setModalData({ ...item });
            setErrorMsg("");
            const modal = new bootstrap.Modal(document.getElementById('myModal'));
            modal.show();
        };

        const handleDelete = (item) => {
            if (window.confirm(`¿Desea eliminar la solicitud con ID: ${item.uniqueId}?`)) {
                axios
                    .delete(API_URL, { data: item })
                    .then(() => {
                        fetchRequests();
                    })
                    .catch((err) => {
                        console.error("Error al eliminar", err);
                    });
            }
        };

        const handleSave = (evt) => {
            evt.preventDefault();

            const now = new Date();
            const year = now.getFullYear();
            const month = ("0" + (now.getMonth() + 1)).slice(-2);
            const day = ("0" + now.getDate()).slice(-2);
            const currentDate = `${year}-${month}-${day}`;
            const hourStr = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2);

            let splitted = modalData.reserveHour.split(" ");
            const extractedHour = splitted.length > 0 ? splitted[0] : "";

            if (modalData.reserveDate < currentDate ||
                (modalData.reserveDate === currentDate && extractedHour < hourStr)) {
                setErrorMsg("No puedes programar para fechas/horas pasadas.");
                return;
            }

            if (!isEditing) {
                axios.post(API_URL, modalData)
                    .then((resp) => {
                        if(resp.data.error){
                            setErrorMsg(resp.data.errorMsg || "Ocurrió un error desconocido");
                        } else {
                            fetchRequests();
                            document.getElementById('closeModalBtn').click();
                        }
                    })
                    .catch((err) => {
                        console.error(err);
                        setErrorMsg("Error al crear la solicitud");
                    });
            } else {
                axios.put(API_URL, modalData)
                    .then((resp) => {
                        if(resp.data.error){
                            setErrorMsg(resp.data.errorMsg || "Ocurrió un error desconocido");
                        } else {
                            fetchRequests();
                            document.getElementById('closeModalBtn').click();
                        }
                    })
                    .catch((err) => {
                        console.error(err);
                        setErrorMsg("Error al actualizar la solicitud");
                    });
            }
        };

        const handleReset = () => {
            setModalData({
                uniqueId: "",
                studentId: "",
                fullName: "",
                emailAddress: "",
                labName: "",
                reserveDate: "",
                reserveHour: ""
            });
            setErrorMsg("");
        };

        return (
            <div>
                <h1 className="text-center mb-4">CRUD Serverless con React</h1>
                <div className="d-flex justify-content-between mb-3">
                    <button className="btn btn-primary" onClick={handleNew}>
                        Nueva Solicitud
                    </button>
                </div>

                <table className="table table-bordered">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Matrícula</th>
                        <th>Laboratorio</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    {requests.map((item) => (
                        <tr key={item.uniqueId || item.id}>
                            <td>{item.uniqueId || item.id}</td>
                            <td>{item.fullName || item.nombre}</td>
                            <td>{item.studentId || item.matricula}</td>
                            <td>{item.labName || item.laboratorio}</td>
                            <td>{item.reserveDate || item.fecha}</td>
                            <td>{item.reserveHour || item.hora}</td>
                            <td>
                                <button
                                    className="btn btn-secondary btn-sm me-2"
                                    onClick={() => handleEdit(item)}
                                >
                                    Editar
                                </button>
                                <button
                                    className="btn btn-danger btn-sm"
                                    onClick={() => handleDelete(item)}
                                >
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    ))}
                    </tbody>
                </table>

                {/* Modal */}
                <div className="modal fade" id="myModal" tabIndex="-1">
                    <div className="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                        <div className="modal-content">
                            <div className="modal-header">
                                <h5>{isEditing ? "Editar Solicitud" : "Nueva Solicitud"}</h5>
                                <button
                                    type="button"
                                    className="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"
                                    id="closeModalBtn">
                                </button>
                            </div>
                            <div className="modal-body">
                                {errorMsg && <div className="alert alert-danger">{errorMsg}</div>}
                                <form onSubmit={handleSave} onReset={handleReset}>
                                    {/* Matrícula */}
                                    <div className="mb-3">
                                        <label className="form-label">Matrícula</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={modalData.studentId}
                                            onChange={(e) =>
                                                setModalData({ ...modalData, studentId: e.target.value })
                                            }
                                            required
                                        />
                                    </div>
                                    {/* Nombre */}
                                    <div className="mb-3">
                                        <label className="form-label">Nombre</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={modalData.fullName}
                                            onChange={(e) =>
                                                setModalData({ ...modalData, fullName: e.target.value })
                                            }
                                            required
                                        />
                                    </div>
                                    {/* Correo */}
                                    <div className="mb-3">
                                        <label className="form-label">Correo</label>
                                        <input
                                            type="email"
                                            className="form-control"
                                            value={modalData.emailAddress}
                                            onChange={(e) =>
                                                setModalData({ ...modalData, emailAddress: e.target.value })
                                            }
                                            required
                                        />
                                    </div>
                                    {/* Laboratorio */}
                                    <div className="mb-3">
                                        <label className="form-label">Laboratorio</label>
                                        <select
                                            className="form-select"
                                            value={modalData.labName}
                                            onChange={(e) =>
                                                setModalData({ ...modalData, labName: e.target.value })
                                            }
                                            required
                                        >
                                            <option value="">Seleccione una opción</option>
                                            <option value="redes">Redes</option>
                                            <option value="computacion">Computación</option>
                                        </select>
                                    </div>
                                    {/* Fecha */}
                                    <div className="mb-3">
                                        <label className="form-label">Fecha</label>
                                        <input
                                            type="date"
                                            className="form-control"
                                            value={modalData.reserveDate}
                                            onChange={(e) =>
                                                setModalData({ ...modalData, reserveDate: e.target.value })
                                            }
                                            required
                                        />
                                    </div>
                                    {/* Hora */}
                                    <div className="mb-3">
                                        <label className="form-label">Hora</label>
                                        <select
                                            className="form-select"
                                            value={modalData.reserveHour}
                                            onChange={(e) =>
                                                setModalData({...modalData, reserveHour: e.target.value})
                                            }
                                            required
                                        >
                                            <option value="">Seleccionar hora</option>
                                            <option value="08:00 a 09:00">08:00 a 09:00</option>
                                            <option value="09:00 a 10:00">09:00 a 10:00</option>
                                            <option value="10:00 a 11:00">10:00 a 11:00</option>
                                            <option value="11:00 a 12:00">11:00 a 12:00</option>
                                            <option value="12:00 a 13:00">12:00 a 13:00</option>
                                            <option value="13:00 a 14:00">13:00 a 14:00</option>
                                            <option value="14:00 a 15:00">14:00 a 15:00</option>
                                            <option value="15:00 a 16:00">15:00 a 16:00</option>
                                            <option value="16:00 a 17:00">16:00 a 17:00</option>
                                            <option value="17:00 a 18:00">17:00 a 18:00</option>
                                            <option value="18:00 a 19:00">18:00 a 19:00</option>
                                            <option value="19:00 a 20:00">19:00 a 20:00</option>
                                            <option value="20:00 a 21:00">20:00 a 21:00</option>
                                            <option value="21:00 a 22:00">21:00 a 22:00</option>
                                        </select>
                                    </div>

                                    <button type="submit" className="btn btn-primary me-2">Guardar</button>
                                    <button type="reset" className="btn btn-outline-secondary">Limpiar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
</script>

<script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous">
</script>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
        integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
        crossorigin="anonymous">
</script>
</body>
</html>
